{
    "contents" : "library(GLMMF)\ndat = read.csv(\"born.csv\")\nY = dat[,-(1:4)]\nX = dat[,2:4] #remove id column\n#remove rare species:\nY = as.matrix(Y[,apply(Y>0,2,sum)>30])\n\nXdat<-do.call(rbind, replicate(ncol(Y), X, simplify=FALSE)) # 5069  3\nspecies<-rep(colnames(Y),each=nrow(Y))\nborneodata<-data.frame(c(Y),Xdat,species)\nnames(borneodata)<-c(\"abundance\",colnames(Xdat),\"species\")\nsave(borneodata,file=\"borneodata.rda\")\n\nload(\"borneodata.rda\")\n\nset.seed(1)\nrandu1<-rnorm(37)\nrandu2<-rnorm(37)\nfitinit<-glmmf(group=\"species\",response=\"abundance\",distinct=~Logging+Slope+randu1+randu2,\n               nfactors=0,distribution=\"poisson\",maxiter=10,\n               data=borneodata,control=list(trace=1,REPORT=1),method=\"BFGS\")\n\ndim(Y)\n\nfitinit$log #-1440.473\ninitmat<-t(matrix(fitinit$coefs[,37],nrow=7)[6:7,])\n\n\n\nfit<-glmmf(group=\"species\",response=\"abundance\",distinct=~Logging+Slope,nfactors=2,distribution=\"poisson\",\n           data=borneodata,control=list(trace=1,REPORT=1,maxit=1000),method=\"BFGS\",init.factor=initmat,estimate=F)\n\nfactors<-fit$coefs[1:2,]\nplot(x=factors[1,],y=factors[2,],pch=NA)\ntext(x=factors[1,],y=factors[2,], labels=as.character(1:28))\n\n\n#####################################################\n\n\nfitinit<-glmm(response.var=\"abundance\",grouping.var=\"species\",\n              fixed=~Logging+Slope+randu1+randu2,\n              latent.factors=0,data=borneodata,distribution=\"poisson\")\n\ninitmat<-t(matrix(fitinit$fixed$coef,ncol=13)[6:7,])\n\ninit.factors<-initmat[lower.tri(initmat,TRUE)]\n\na<-proc.time()\nfit<-glmm(response.var=\"abundance\",grouping.var=\"species\",fixed=~Logging+Slope,\n          latent.factors=2,init.factors=init.factors,data=borneodata,distribution=\"poisson\",print_level=1,maxeval=1000000)\n\nproc.time()-a\n\ninitmat<-t(tail(matrix(out$coef,ncol=ncol(Y)),2))\n\ninit.factors<-initmat[lower.tri(initmat,TRUE)]\n\nY = dat[,-(1:4)]\nX = dat[,2:4] #remove id column\n#remove rare species:\nY = as.matrix(Y[,apply(Y>0,2,sum)>10])\n\nXdat<-do.call(rbind, replicate(ncol(Y), X, simplify=FALSE)) # 5069  3\nspecies<-rep(colnames(Y),each=nrow(Y))\nborneodata<-data.frame(c(Y),Xdat,species)\nnames(borneodata)<-c(\"abundance\",colnames(Xdat),\"species\")\n\n\na<-proc.time()\nfit<-glmm(response.var=\"abundance\",grouping.var=\"species\",fixed=~Logging+Slope,\n          latent.factors=2,init.factors=init.factors,data=borneodata,distribution=\"poisson\",print_level=1,maxeval=1000000)\n\n\n\nfit$fixed$coef\nfit$factors$u\nsave(fit,file=\"fit30.rda\")\nplot(unclass(fit$factors$u),pch=NA)\ntext(unclass(fit$factors$u), labels=as.character(1:37))\n\nplot(unclass(fit$factors$u),type=\"n\",main=\"LV + main effects\",xlab=\"LV1\",ylab=\"LV2\")\npoints(unclass(fit$factors$u),col=as.numeric(dat[,2]),pch=as.numeric(dat[,3]))\nlegend(\"bottomright\", c(\"P\",\"L89\",\"L93\",\"L\",\"M\",\"U\"),col=c(3,1,2,1,1,1),pch=c(15,15,15,1,2,3))\n\n####\n\n\nset.seed(1)\nrandu1<-rnorm(37)\nrandu2<-rnorm(37)\n\nfitinit<-glmm(response.var=\"abundance\",grouping.var=\"species\",\n              fixed=~randu1+randu2,\n              latent.factors=0,data=borneodata,distribution=\"poisson\")\n\ninitmat<-t(matrix(fitinit$fixed$coef,ncol=13)[2:3,])\n\ninit.factors<-initmat[lower.tri(initmat,TRUE)]\n\na<-proc.time()\nfit<-glmm(response.var=\"abundance\",grouping.var=\"species\",fixed=~1,\n          latent.factors=2,init.factors=init.factors,data=borneodata,distribution=\"poisson\",print_level=1,maxeval=1000000)\n\nproc.time()-a\n\n\nsave(fit,file=\"fit30noX.rda\")\nplot(unclass(fit$factors$u),type=\"n\",main=\"LV + intercept\",xlab=\"LV1\",ylab=\"LV2\")\npoints(unclass(fit$factors$u),col=as.numeric(dat[,2]),pch=as.numeric(dat[,3]))\nlegend(\"bottomright\", c(\"P\",\"L89\",\"L93\",\"L\",\"M\",\"U\"),col=c(3,1,2,1,1,1),pch=c(15,15,15,1,2,3))\n\n####\ndat = read.csv(\"born.csv\")\nY = dat[,-(1:4)]\nX = dat[,1:4]\n\nXNew <- model.matrix(~Logging+Slope,data=X)\nXNew <- XNew[,-1]\n\n#remove rare species:\nY = as.matrix(Y[,apply(Y>0,2,sum)>3])\n\n\n\n## Starting values by fitting marginal glm's\nstart.values <- function(data, X, family, trial.size = NULL, num.lv = 2,seed=1) {\n  N <- nrow(data)\n  p <- ncol(data)\n  data <- as.matrix(data)\n  set.seed(seed)\n  index <- rmvnorm(N,rep(0,num.lv))\n  if(!is.null(X)) fit.mva <- manyglm(data~X+index,family=family, K = trial.size)  \n  if(is.null(X)) fit.mva <- manyglm(data~index,family=family, K = trial.size)  \n  params <- t(fit.mva$coef)\n  if(family == \"negative.binomial\") { phi <- fit.mva$phi } else { phi <- rep(1,p) }\n  \n  list(params=params,index=index,phi=phi)\n}\n\nlibrary(mvtnorm)\nlibrary(mvabund)\nsv<-start.values(Y,XNew,\"poisson\")\n\nplot(ft_main$lvs,type=\"n\",main=\"LV + main effects\",xlab=\"LV1\",ylab=\"LV2\")\npoints(ft_main$lvs,col=as.numeric(X[,2]),pch=as.numeric(X[,3]))\nlegend(\"bottomright\", c(\"P\",\"L89\",\"L93\",\"L\",\"M\",\"U\"),col=c(3,1,2,1,1,1),pch=c(15,15,15,1,2,3))\n",
    "created" : 1414143632455.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1802742116",
    "id" : "1AEC282C",
    "lastKnownWriteTime" : 1414144800,
    "path" : "U:/MyPrograms/gitrepos/GLMMF/borneo.R",
    "project_path" : "borneo.R",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}