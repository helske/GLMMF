{
    "contents" : "library(GLMMF)\ndat = read.csv(\"born.csv\")\nY = dat[,-(1:4)]\nX = dat[,2:4] #remove id column\n#remove rare species:\nY = as.matrix(Y[,apply(Y>0,2,sum)>30])\n\nXdat<-do.call(rbind, replicate(ncol(Y), X, simplify=FALSE)) # 5069  3\nspecies<-rep(colnames(Y),each=nrow(Y))\nborneodata<-data.frame(c(Y),Xdat,species)\nnames(borneodata)<-c(\"abundance\",colnames(Xdat),\"species\")\nsave(borneodata,file=\"borneodata.rda\")\n\nload(\"borneodata.rda\")\n\n\nset.seed(12345)\nrandu1<-rnorm(37)\nrandu2<-rnorm(37)\nfitinit<-glmmf(group=\"species\",response=\"abundance\",distinct=~randu1+randu2,\n               nfactors=0,distribution=\"poisson\",maxiter=100,maxiter2=0,\n               data=borneodata,control=list(trace=1,REPORT=1),method=\"BFGS\",trace=2,estimate=T)\n\n\nfitinit$log #-8241.699\ninitmat<-t(matrix(fitinit$coefs[,37],nrow=3)[2:3,])\n\n\na<-proc.time()\nfitBFGS<-glmmf(group=\"species\",response=\"abundance\",distinct=~1,nfactors=2,distribution=\"poisson\",\n             convtol=1e-10,maxiter=50,maxiter2=0,init.theta=\"iterative\",init.factor=initmat,\n             data=borneodata,control=list(maxit=50,trace=1,REPORT=10),method=\"BFGS\",estimate=T,trace=1)\nproc.time()-a\n\ninstall.packages(\"maxLik\")\n\n\na<-proc.time()\nfitBFGS<-glmmf2(group=\"species\",response=\"abundance\",distinct=~1,nfactors=2,distribution=\"poisson\",\n               convtol=1e-10,maxiter=50,maxiter2=0,init.theta=\"iterative\",init.factor=initmat,gradient=F,\n               data=borneodata,control=list(maxit=50,trace=1,REPORT=1,fnscale=-1),method=\"BFGS\",estimate=T,trace=1)\nproc.time()-a\n\n\na<-proc.time()\nfitMaxLik<-glmmf2(group=\"species\",response=\"abundance\",distinct=~1,nfactors=2,distribution=\"poisson\",\n               convtol=1e-10,maxiter=50,maxiter2=0,init.theta=\"iterative\",init.factor=initmat,\n               data=borneodata,print.level=3,estimate=T,trace=1,method=\"NR\")\nproc.time()-a\n\n\n#n>30:\n#7.77 sec\n#1346.198495 \n\n\na<-proc.time()\nparfit<-parallel_glmmf(group=\"species\",response=\"abundance\",distinct=~1,nfactors=2,distribution=\"poisson\",\n                       convtol=1e-6,maxiter=25,maxiter2=10,init.theta=fitinit$linear.predictor,\n                       data=borneodata,control=list(maxit=100,trace=1,REPORT=1),method=\"BFGS\",init.factor=initmat,\n                       estimate=T,trace=1,group_size=4,threads=8,samples=8)\nproc.time()-a\n\n\n####\n\n\n\na<-proc.time()\nfit<-glmmf(group=\"species\",response=\"abundance\",distinct=~1,nfactors=2,distribution=\"poisson\",\n            convtol=1e-8,maxiter=50,maxiter2=10,init.theta=fitinit$linear.predictor,\n            data=borneodata,control=list(maxit=10000,trace=1),method=\"Nelder-Mead\",init.factor=initmat,estimate=T,trace=1)\nproc.time()-a\n\n\na<-proc.time()\nfit<-glmmf(group=\"species\",response=\"abundance\",distinct=~1,nfactors=2,distribution=\"poisson\",\n           convtol=1e-8,maxiter=50,maxiter2=10,init.theta=fitinit$linear.predictor,\n           data=borneodata,control=list(maxit=1000),method=\"BFGS\",init.factor=initmat,estimate=T,trace=1)\nfit$log #-7957.194\n\nmicrobenchmark(\nfit2<-glmmf(group=\"species\",response=\"abundance\",distinct=~1,nfactors=2,distribution=\"poisson\",\n            convtol=1e-8,maxiter=50,maxiter2=10,init.theta=fitinit$linear.predictor,\n            data=borneodata,control=list(maxit=3,trace=1,REPORT=1),method=\"BFGS\",init.factor=initmat,estimate=T,trace=1),times=1)\n#58.18007 seconds\n\nsplit(1:96, cut(1:96, 96%/%12))\n\na<-proc.time()\nfit<-glmmf(group=\"species\",response=\"abundance\",distinct=~1,nfactors=2,distribution=\"negative binomial\",\n           convtol=1e-8,maxiter=50,maxiter2=10,init.theta=fitinit$linear.predictor,\n           data=borneodata,control=list(trace=1,REPORT=1,maxit=1000),method=\"BFGS\",init.factor=initmat,estimate=T,trace=1)\nfit$log #-7957.194\n\na<-proc.time()\nparfit<-parallel_glmmf(group=\"species\",response=\"abundance\",distinct=~1,nfactors=2,distribution=\"poisson\",\n               convtol=1e-6,maxiter=25,maxiter2=10,init.theta=fitinit$linear.predictor,\n               data=borneodata,control=list(maxit=100,trace=1,REPORT=1),method=\"BFGS\",init.factor=initmat,estimate=T,trace=1,group_size=6,threads=8,samples=16,par.maxit=5)\nproc.time()-a\n\nparfit10noX<-parfit\nsave(parfit10noX,file=\"parfit10noX.rda\")\n\nfit<-parfit10noX\nfit$log #-1346.198\nfit$coefs\nfactors<-fit$coefs[1:2,]\nplot(x=factors[1,],y=factors[2,],pch=NA)\ntext(x=factors[1,],y=factors[2,], labels=as.character(1:37))\n\nfitinit10noX<-fitinit\nfit10noX<-fit\nsave(fitinit10noX,fit10nox,file=\"fitBorneo10.rda\")\n\nfactors<-fit_glmmf2$coefs[1:2,]\ndat = read.csv(\"born.csv\")\nX = dat[,1:4] #remove id column\nplot(x=factors[1,],y=factors[2,],type=\"n\",main=\"LV + intercept\",xlab=\"LV1\",ylab=\"LV2\")\npoints(x=factors[1,],y=factors[2,],col=as.numeric(X[,2]),pch=as.numeric(X[,3]))\nlegend(\"topleft\", c(\"P\",\"L89\",\"L93\",\"L\",\"M\",\"U\"),col=c(3,1,2,1,1,1),pch=c(15,15,15,1,2,3))\n\n\n\nset.seed(12345)\nrandu1<-rnorm(37)\nrandu2<-rnorm(37)\nfitinit<-glmmf(group=\"species\",response=\"abundance\",distinct=~Logging+Slope+randu1+randu2,\n               nfactors=0,distribution=\"poisson\",maxiter=100,\n               data=borneodata,control=list(trace=1,REPORT=1),method=\"BFGS\",trace=2)\n\n\nglm(abundance~Logging+Slope+randu1+randu2,family=poisson(),data=borneodata[borneodata$species==\"Irena_puella\",])\nfitinit$log #-1433.71\ninitmat<-t(matrix(fitinit$coefs[,37],nrow=7)[6:7,])\n\n\n\nfit<-glmmf(group=\"species\",response=\"abundance\",distinct=~Logging+Slope,nfactors=2,distribution=\"poisson\",\n           convtol=1e-8,maxiter=25,maxiter2=10,init.theta=fitinit$linear.predictor,\n           data=borneodata,control=list(trace=1,REPORT=1,maxit=10),method=\"BFGS\",init.factor=initmat,estimate=F,trace=2)\nfit$log \n\n(fit$log-fit2$log)/(abs(fit$log)+0.1)\nmax(abs(fit2$lin-fit$lin))\nfit2<-fit\nsave(fit2,file=\"fit2.rda\")\n\nall.equal(fit$model,fit2$model)\nall.equal(fit,fit2)\nfit2<-fit\nmodel2<-fit2$model\nrnorm(10)\nnames(fit)\nfit$lin\nfactors<-fit$coefs[1:2,]\nplot(x=factors[1,],y=factors[2,],pch=NA)\ntext(x=factors[1,],y=factors[2,], labels=as.character(1:28))\n\n\n#####################################################\n\n\nfitinit<-glmm(response.var=\"abundance\",grouping.var=\"species\",\n              fixed=~Logging+Slope+randu1+randu2,\n              latent.factors=0,data=borneodata,distribution=\"poisson\")\n\ninitmat<-t(matrix(fitinit$fixed$coef,ncol=13)[6:7,])\n\ninit.factors<-initmat[lower.tri(initmat,TRUE)]\n\na<-proc.time()\nfit<-glmm(response.var=\"abundance\",grouping.var=\"species\",fixed=~Logging+Slope,\n          latent.factors=2,init.factors=init.factors,data=borneodata,distribution=\"poisson\",print_level=1,maxeval=1000000)\n\nproc.time()-a\n\ninitmat<-t(tail(matrix(out$coef,ncol=ncol(Y)),2))\n\ninit.factors<-initmat[lower.tri(initmat,TRUE)]\n\nY = dat[,-(1:4)]\nX = dat[,2:4] #remove id column\n#remove rare species:\nY = as.matrix(Y[,apply(Y>0,2,sum)>10])\n\nXdat<-do.call(rbind, replicate(ncol(Y), X, simplify=FALSE)) # 5069  3\nspecies<-rep(colnames(Y),each=nrow(Y))\nborneodata<-data.frame(c(Y),Xdat,species)\nnames(borneodata)<-c(\"abundance\",colnames(Xdat),\"species\")\n\n\na<-proc.time()\nfit<-glmm(response.var=\"abundance\",grouping.var=\"species\",fixed=~Logging+Slope,\n          latent.factors=2,init.factors=init.factors,data=borneodata,distribution=\"poisson\",print_level=1,maxeval=1000000)\n\n\n\nfit$fixed$coef\nfit$factors$u\nsave(fit,file=\"fit30.rda\")\nplot(unclass(fit$factors$u),pch=NA)\ntext(unclass(fit$factors$u), labels=as.character(1:37))\n\nplot(unclass(fit$factors$u),type=\"n\",main=\"LV + main effects\",xlab=\"LV1\",ylab=\"LV2\")\npoints(unclass(fit$factors$u),col=as.numeric(dat[,2]),pch=as.numeric(dat[,3]))\nlegend(\"bottomright\", c(\"P\",\"L89\",\"L93\",\"L\",\"M\",\"U\"),col=c(3,1,2,1,1,1),pch=c(15,15,15,1,2,3))\n\n####\n\n\nset.seed(1)\nrandu1<-rnorm(37)\nrandu2<-rnorm(37)\n\nfitinit<-glmm(response.var=\"abundance\",grouping.var=\"species\",\n              fixed=~randu1+randu2,\n              latent.factors=0,data=borneodata,distribution=\"poisson\")\n\ninitmat<-t(matrix(fitinit$fixed$coef,ncol=13)[2:3,])\n\ninit.factors<-initmat[lower.tri(initmat,TRUE)]\n\na<-proc.time()\nfit<-glmm(response.var=\"abundance\",grouping.var=\"species\",fixed=~1,\n          latent.factors=2,init.factors=init.factors,data=borneodata,distribution=\"poisson\",print_level=1,maxeval=1000000)\n\nproc.time()-a\n\n\nsave(fit,file=\"fit30noX.rda\")\nplot(unclass(fit$factors$u),type=\"n\",main=\"LV + intercept\",xlab=\"LV1\",ylab=\"LV2\")\npoints(unclass(fit$factors$u),col=as.numeric(dat[,2]),pch=as.numeric(dat[,3]))\nlegend(\"bottomright\", c(\"P\",\"L89\",\"L93\",\"L\",\"M\",\"U\"),col=c(3,1,2,1,1,1),pch=c(15,15,15,1,2,3))\n\n####\ndat = read.csv(\"born.csv\")\nY = dat[,-(1:4)]\nX = dat[,1:4]\n\nXNew <- model.matrix(~Logging+Slope,data=X)\nXNew <- XNew[,-1]\n\n#remove rare species:\nY = as.matrix(Y[,apply(Y>0,2,sum)>3])\n\n\n\n## Starting values by fitting marginal glm's\nstart.values <- function(data, X, family, trial.size = NULL, num.lv = 2,seed=1) {\n  N <- nrow(data)\n  p <- ncol(data)\n  data <- as.matrix(data)\n  set.seed(seed)\n  index <- rmvnorm(N,rep(0,num.lv))\n  if(!is.null(X)) fit.mva <- manyglm(data~X+index,family=family, K = trial.size)  \n  if(is.null(X)) fit.mva <- manyglm(data~index,family=family, K = trial.size)  \n  params <- t(fit.mva$coef)\n  if(family == \"negative.binomial\") { phi <- fit.mva$phi } else { phi <- rep(1,p) }\n  \n  list(params=params,index=index,phi=phi)\n}\n\nlibrary(mvtnorm)\nlibrary(mvabund)\nsv<-start.values(Y,XNew,\"poisson\")\n\nplot(ft_main$lvs,type=\"n\",main=\"LV + main effects\",xlab=\"LV1\",ylab=\"LV2\")\npoints(ft_main$lvs,col=as.numeric(X[,2]),pch=as.numeric(X[,3]))\nlegend(\"bottomright\", c(\"P\",\"L89\",\"L93\",\"L\",\"M\",\"U\"),col=c(3,1,2,1,1,1),pch=c(15,15,15,1,2,3))\n",
    "created" : 1414400291040.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1379089861",
    "id" : "9638661B",
    "lastKnownWriteTime" : 1415194160,
    "path" : "U:/MyPrograms/gitrepos/GLMMF/borneo.R",
    "project_path" : "borneo.R",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}