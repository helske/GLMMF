{
    "contents" : "library(GLMMF)\nlibrary(StateSpaceGLMM)\nlibrary(nloptr)\nlibrary(KFAS)\nlibrary(numDeriv)\ndat = read.csv(\"../GLMMF/born.csv\")\nY = dat[,-(1:4)]\nX = dat[,2:4] #remove id column\n#remove rare species:\nY = as.matrix(Y[,apply(Y>0,2,sum)>30])\n\nXdat<-do.call(rbind, replicate(ncol(Y), X, simplify=FALSE)) # 5069  3\nspecies<-rep(colnames(Y),each=nrow(Y))\nborneodata<-data.frame(c(Y),Xdat,species)\nnames(borneodata)<-c(\"abundance\",colnames(Xdat),\"species\")\n\nset.seed(12345)\nrandu1<-rnorm(37)\nrandu2<-rnorm(37)\n\nfitinit_glmmf<-glmmf(group=\"species\",response=\"abundance\",distinct=~randu1+randu2,\n                     nfactors=0,distribution=\"poisson\",maxiter=100,\n                     data=borneodata,control=list(trace=1,REPORT=1),method=\"BFGS\",trace=2,estimate=F)\n\nfitinit_glmmf$log #-1561.845\ninitmat_glmmf<-t(matrix(fitinit_glmmf$coefs[,37],nrow=3)[2:3,])\n\na<-proc.time()\nfit_glmmf2<-glmmf2(group=\"species\",response=\"abundance\",distinct=~1,nfactors=2,distribution=\"poisson\",\n                 convtol=1e-8,maxiter=100,maxiter2=5,init.factor=initmat_glmmf,\n                 data=borneodata, estimate=T,trace=1,epsilon=1e-8,maxapp=100,gradient=TRUE,\n                 check.analyticals=FALSE,print.level=0,typsize=rep(0,sum(lower.tri(initmat_glmmf,TRUE))),\n                 fscale=7000,iterlim=50)\nproc.time()-a\n# -7127.43818564259\n# 1301.23 sec\n# 7 maxapp-iteraatiota\n#\n\na<-proc.time()\nfit_glmmf3<-glmmf2(group=\"species\",response=\"abundance\",distinct=~1,nfactors=2,distribution=\"poisson\",\n                   convtol=1e-8,maxiter=100,maxiter2=5,init.factor=initmat_glmmf,\n                   data=borneodata, estimate=T,trace=1,epsilon=1e-8,maxapp=100,gradient=TRUE,\n                   check.analyticals=FALSE,print.level=0,typsize=rep(0,sum(lower.tri(initmat_glmmf,TRUE))),\n                   fscale=7000,iterlim=500)\nproc.time()-a\n# -7127.43818564259\n# 1791.86 \n# \"ApproxMaximization iter 6 log-likelihood -7127.43818564259\"\n\nload(\"fit10approx.rda\")\n\nfactors<-fit10a$coefs[1:2,]\ndat = read.csv(\"born.csv\")\nX = dat[,1:4] #remove id column\nplot(x=factors[1,],y=factors[2,],type=\"n\",main=\"LV + intercept\",xlab=\"LV1\",ylab=\"LV2\")\npoints(x=factors[1,],y=factors[2,],col=as.numeric(X[,2]),pch=as.numeric(X[,3]))\nlegend(\"bottomright\", c(\"P\",\"L89\",\"L93\",\"L\",\"M\",\"U\"),col=c(3,1,2,1,1,1),pch=c(15,15,15,1,2,3))\n\nt(fit10a$model$Z[1:2,,1])\n\n#fit_glmmf2$logLik\n# >10: -7957.194\n\n# >20:\n# \"Iter 4 log-likelihood 4628.61211358786\"\n# > proc.time()-a\n# user  system elapsed \n# 128.13    0.32  128.81 \n\nlibrary(microbenchmark)\n\nmicrobenchmark(\nfit_glmmf2<-glmmf2(group=\"species\",response=\"abundance\",distinct=~1,nfactors=2,distribution=\"poisson\",\n                   convtol=1e-8,maxiter=100,maxiter2=5,init.factor=initmat_glmmf,\n                   data=borneodata, estimate=F,trace=0,epsilon=1e-5,print.level=0,gradient=TRUE,check.analyticals=FALSE),\n\nfit_glmmf2<-glmmf2(group=\"species\",response=\"abundance\",distinct=~1,nfactors=2,distribution=\"poisson\",\n                   convtol=1e-8,maxiter=100,maxiter2=5,init.factor=initmat_glmmf,\n                   data=borneodata, estimate=T,trace=0,epsilon=1e-5,print.level=0,gradient=TRUE,check.analyticals=TRUE),\n\nfit_glmmf2<-glmmf2(group=\"species\",response=\"abundance\",distinct=~1,nfactors=2,distribution=\"poisson\",\n                   convtol=1e-8,maxiter=100,maxiter2=5,init.factor=initmat_glmmf,\n                   data=borneodata, estimate=T,trace=0,epsilon=1e-5,print.level=0,gradient=FALSE),times=5)\n# min         lq       mean     median         uq        max neval cld\n# 686.1772   691.2514   692.6971   692.0845   692.8338   701.1388     5 a  \n# 1119.0128  1121.8169  1125.9374  1123.4147  1129.3156  1136.1267     5  b \n# 11880.2862 11916.1517 11939.8279 11947.8354 11974.2710 11980.5952     5   c\nfit_glmmf2$logLik #-1346.198\n\n\nGLMMF:::expfLogLikNoSim(model$y, model$Z, model$u, model$a1, model$P1, model$P1inf, \n                2, model$tol, 100, 0, 1e-5, theta, model$Zind, model$nfactors,trace,1)$logLik\n",
    "created" : 1415172667022.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1230947770",
    "id" : "9B9E2F68",
    "lastKnownWriteTime" : 1417788970,
    "path" : "U:/MyPrograms/gitrepos/GLMMF/approxMethod.R",
    "project_path" : "approxMethod.R",
    "properties" : {
        "tempName" : "Untitled6"
    },
    "source_on_save" : false,
    "type" : "r_source"
}